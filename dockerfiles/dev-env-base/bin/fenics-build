#!/bin/bash

set -e

PYTHON="${PYTHON:-python}"
FENICS_BUILD_TYPE="${FENICS_BUILD_TYPE:-Release}"

if [ -z "$SRC_DIR" ]; then
    echo "SRC_DIR must be defined" >&2
    exit -1
fi

if [ -z "${FENICS_HOME}" ]; then
    echo "FENICS_HOME must be defined" >&2
    exit -1
fi

function build_cmake () {
    # build a project with cmake (dolfin, mshr)
    project="$1"
    echo "FENICS-BUILDER: Building $project with CMake..."

    build="$SRC_DIR/$project/build"
    mkdir -p "$build"
    cd "$build"
    cmake ../ -DCMAKE_INSTALL_PREFIX=${FENICS_HOME} -DCMAKE_BUILD_TYPE=${FENICS_BUILD_TYPE} -DPYTHON_EXECUTABLE:FILEPATH=${PYTHON} -Wno-dev ${CMAKE_EXTRA_ARGS}
    make
    make install
}

function build () {
    for project in $@; do
        echo "FENICS-BUILDER: Building $project..."
        path="$SRC_DIR/$project"
        if [ ! -d "$path" ]; then
            echo "FENICS-BUILDER: $project source cannot be found at $path. Please run fenics-pull first."
            exit -1
        fi
        if [ -e $path/CMakeLists.txt ]; then
            build_cmake "$project"
        else
            cd "$path"
            ${PYTHON} -m pip install --prefix=${FENICS_HOME} --no-deps --upgrade .
        fi
    done
}

if [ -z "$1" ]; then
    if [ "${FENICS_VERSION}" == "1.6.0" ]; then
        pull fiat instant ufl ffc dolfin
    else
        pull fiat dijitso instant ufl ffc dolfin
    fi
else
    build $@
fi
